<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Détails du post</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css" rel="stylesheet">
    <style>
        .post-detail {
            margin-top: 30px;
            max-width: 800px;
        }

        .post-title {
            font-size: 2rem;
            margin-bottom: 20px;
        }

        .post-content p {
            font-size: 1.1rem;
            color: #555;
            margin-bottom: 15px;
            text-align: justify;
        }

        .post-image {
            width: 300px;
            height: auto;
            object-fit: cover;
            border-radius: 8px;
            margin: 10px 20px 10px 0;
            float: left; /* Fait en sorte que l'image s'intègre dans le texte */
        }

        .author-info {
            font-size: 0.9rem;
            color: #888;
            margin-bottom: 15px;
        }

        .comment-actions {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 15px;
        }

        .comment-actions button {
            font-size: 1.2rem;
            background: none;
            border: none;
            cursor: pointer;
        }

        .comment-actions button:hover {
            color: #007bff;
        }

        .comment-form button {
            margin-top: 10px;
            background-color: #007bff;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }

        .comment-form button:hover {
            background-color: #0056b3;
        }

        /* Styles pour la section des commentaires */
        #comments-section {
            display: none;
            margin-top: 30px;
        }
    </style>
</head>
<body>

<!-- Navbar -->
<nav class="navbar navbar-expand-lg navbar-light bg-light">
    <div class="container">
        <a class="navbar-brand" href="#">Forum</a>
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarNav">
            <ul class="navbar-nav ms-auto">
                <li class="nav-item">
                    <a class="nav-link" href="#">Accueil</a>
                </li>
                {% if user.is_authenticated %}
                <li class="nav-item">
                    <a class="nav-link" href="#"><i class="bi bi-chat"></i> Chat</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="#"><i class="bi bi-bell"></i> Notifications</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="#"><i class="bi bi-person-circle"></i> Profil</a>
                </li>
                {% endif %}
            </ul>
        </div>
    </div>
</nav>

<div class="container post-detail">
    <!-- Contenu du post -->
    <div class="post-content">
        <!-- Titre du post et informations sur l'auteur -->
        <h2 class="post-title">{{ post.title }}</h2>
        <p class="author-info d-flex justify-content-between align-items-center">
            <span>
                <strong>Auteur:</strong> {{ post.author.username }} | 
                <strong>Publié le:</strong> {{ post.created_at|date:"d M Y" }}
            </span>
            <!-- Boutons S'abonner et Message -->
            <div class="d-flex align-items-center">
                <!-- Formulaire d'abonnement -->
                <form method="POST" action="{% url 'subscribe' post.id %}" id="subscribe-form-{{ post.id }}" class="me-2">
                    {% csrf_token %}
                    <button type="submit" class="btn btn-primary" id="subscribe-button-{{ post.id }}">
                        {% if user in post.subscriptions.all %}
                            Se désabonner
                        {% else %}
                            S'abonner
                        {% endif %}
                    </button>
                </form>
                
                <!-- Bouton Message -->
                <button class="btn btn-primary" id="message-btn">
                    Message
                </button>
            </div>
            
        </p>        
        
        <!-- Image du post -->
        <img src="{{ post.image.url }}" alt="Image du post" class="post-image">
        
        <!-- Contenu du texte -->
        <p>{{ post.content }}</p>

        <!-- Boutons J'aime / Je n'aime pas et Partager avec comptabilisation -->
        <div class="comment-actions">
            <div>
                <button id="like-btn" class="like-dislike-btn" onclick="toggleLike()">
                    {% if user in post.likes.all %}
                        <i class="bi bi-hand-thumbs-up" style="color: blue;"></i> Retirer le like
                    {% else %}
                        <i class="bi bi-hand-thumbs-up"></i> Aimer
                    {% endif %}
                </button>
                <span id="like-count">{{ post.likes.count }}</span> <!-- Affichage du nombre de likes -->

                <button id="dislike-btn" class="like-dislike-btn" onclick="toggleDislike()">
                    {% if user in post.dislikes.all %}
                        <i class="bi bi-hand-thumbs-down" style="color: red;"></i> Retirer le dislike
                    {% else %}
                        <i class="bi bi-hand-thumbs-down"></i> Disliker
                    {% endif %}
                </button>
                <span id="dislike-count">{{ post.dislikes.count }}</span> <!-- Affichage du nombre de dislikes -->
            </div>
            <div>
                <button id="toggle-comments-btn" class="like-dislike-btn">
                    <i class="bi bi-chat"></i> Commenter
                </button>
                <button class="like-dislike-btn">
                    <i class="bi bi-share"></i> Partager
                </button>
            </div>
        </div>
    </div>

    <!-- Section des commentaires -->
    <div id="comments-section">
        <h3>Commentaires:</h3>
        {% for comment in comments %}
            <div class="comment">
                <p><strong>{{ comment.user.username }}:</strong> {{ comment.content }}</p>
            </div>
        {% endfor %}

        <!-- Formulaire d'ajout de commentaire -->
        <div class="comment-form">
            <form method="POST" action="{% url 'add_comment' post.id %}">
                {% csrf_token %}
                <textarea name="content" placeholder="Ajoutez un commentaire..." rows="3" class="form-control"></textarea>
                <button type="submit" class="btn btn-primary mt-2">Commenter</button>
            </form>
        </div>
    </div>
</div>

<!-- Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
    // Fonction JavaScript pour gérer l'interaction avec les boutons Like et Dislike
    function toggleLike() {
        var likeButton = document.getElementById('like-btn');
        var dislikeButton = document.getElementById('dislike-btn');
        var likeCount = document.getElementById('like-count');
        
        // Inverser l'état du like
        if (likeButton.classList.contains('liked')) {
            likeButton.classList.remove('liked');
            likeCount.textContent = parseInt(likeCount.textContent) - 1;
        } else {
            likeButton.classList.add('liked');
            likeCount.textContent = parseInt(likeCount.textContent) + 1;
            // Retirer le dislike si le like est ajouté
            if (dislikeButton.classList.contains('disliked')) {
                dislikeButton.classList.remove('disliked');
                var dislikeCount = document.getElementById('dislike-count');
                dislikeCount.textContent = parseInt(dislikeCount.textContent) - 1;
            }
        }
    }

    function toggleDislike() {
        var dislikeButton = document.getElementById('dislike-btn');
        var likeButton = document.getElementById('like-btn');
        var dislikeCount = document.getElementById('dislike-count');
        
        // Inverser l'état du dislike
        if (dislikeButton.classList.contains('disliked')) {
            dislikeButton.classList.remove('disliked');
            dislikeCount.textContent = parseInt(dislikeCount.textContent) - 1;
        } else {
            dislikeButton.classList.add('disliked');
            dislikeCount.textContent = parseInt(dislikeCount.textContent) + 1;
            // Retirer le like si le dislike est ajouté
            if (likeButton.classList.contains('liked')) {
                likeButton.classList.remove('liked');
                var likeCount = document.getElementById('like-count');
                likeCount.textContent = parseInt(likeCount.textContent) - 1;
            }
        }
    }

    // Afficher ou masquer la section des commentaires
    document.getElementById('toggle-comments-btn').addEventListener('click', function() {
        var commentsSection = document.getElementById('comments-section');
        if (commentsSection.style.display === "none") {
            commentsSection.style.display = "block";
        } else {
            commentsSection.style.display = "none";
        }
    });
    // Sélectionner le formulaire et le bouton d'abonnement
    const form = document.getElementById('subscribe-form-{{ post.id }}');
    const button = document.getElementById('subscribe-button-{{ post.id }}');

    // Ajouter un écouteur d'événements pour l'envoi du formulaire
    form.addEventListener('submit', function(event) {
        event.preventDefault();  // Empêche le formulaire de se soumettre normalement

        // Envoyer la requête AJAX pour gérer l'abonnement/désabonnement
        fetch(form.action, {
            method: 'POST',
            body: new FormData(form),  // Formulaire encodé en multipart
            headers: {
                'X-Requested-With': 'XMLHttpRequest',  // Indique que la requête est AJAX
            },
        })
        .then(response => response.json())  // Réponse au format JSON
        .then(data => {
            // Changer le texte du bouton en fonction de l'état d'abonnement
            if (data.is_subscribed) {
                button.textContent = 'Se désabonner';
            } else {
                button.textContent = 'S\'abonner';
            }
        })
        .catch(error => {
            console.error('Erreur lors de l\'abonnement :', error);
        });
    });
</script>

</body>
</html>
